---
import Layout from '../layouts/Layout.astro';
---

<Layout title="ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†ç”»é¢ - å­¦æ ¡ç¥­äºˆç´„ã‚·ã‚¹ãƒ†ãƒ ">
	<main>
		<div class="container">
			<header>
				<h1>ğŸ“Š ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†ç”»é¢</h1>
				<p>äºˆç´„ã®ç¢ºèªãƒ»ç®¡ç†ã‚’è¡Œãˆã¾ã™</p>
			</header>

			<!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
			<div id="loginForm" class="login-form">
				<h2>ğŸ” ã‚¹ã‚¿ãƒƒãƒ•èªè¨¼</h2>
				<form id="staffLogin">
					<div class="form-group">
						<label for="password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
						<input type="password" id="password" name="password" required placeholder="ã‚¹ã‚¿ãƒƒãƒ•ç”¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
					</div>
					<button type="submit" class="login-btn">ãƒ­ã‚°ã‚¤ãƒ³</button>
				</form>
			</div>

			<!-- ç®¡ç†ç”»é¢ãƒ¡ã‚¤ãƒ³ -->
			<div id="dashboard" class="dashboard hidden">
				<div class="dashboard-header">
					<h2>äºˆç´„ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h2>
					<div class="actions">
						<button id="refreshBtn" class="refresh-btn">ğŸ”„ æ›´æ–°</button>
						<button id="logoutBtn" class="logout-btn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
					</div>
				</div>

				<!-- çµ±è¨ˆæƒ…å ± -->
				<div id="stats" class="stats-grid">
					<!-- çµ±è¨ˆã‚«ãƒ¼ãƒ‰ãŒå‹•çš„ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
				</div>

				<!-- äºˆç´„ä¸€è¦§ -->
				<div class="reservations-section">
					<h3>ğŸ“‹ äºˆç´„ä¸€è¦§</h3>
					<div class="filters">
						<select id="statusFilter">
							<option value="all">ã™ã¹ã¦</option>
							<option value="active">æœ‰åŠ¹</option>
							<option value="cancelled">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</option>
						</select>
						<select id="menuFilter">
							<option value="all">ã™ã¹ã¦ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼</option>
						</select>
						<select id="timeFilter">
							<option value="all">ã™ã¹ã¦ã®æ™‚é–“å¸¯</option>
						</select>
					</div>
					<div id="reservationsList" class="reservations-list">
						<!-- äºˆç´„ãƒªã‚¹ãƒˆãŒå‹•çš„ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
					</div>
				</div>
			</div>

			<div id="loading" class="loading hidden">
				<div class="spinner"></div>
				<p>èª­ã¿è¾¼ã¿ä¸­...</p>
			</div>

			<div id="error" class="error hidden"></div>
		</div>
	</main>

	<script>
		interface Reservation {
			id: string;
			name: string;
			phone: string;
			email?: string;
			people: string;
			menu: string;
			time: string;
			notes?: string;
			createdAt: string;
			status: 'active' | 'cancelled';
		}

		interface Stats {
			total: number;
			active: number;
			cancelled: number;
			byMenu: Record<string, number>;
			byTime: Record<string, number>;
		}

		let currentPassword = '';
		let reservationsData: Reservation[] = [];
		let statsData: Stats = {
			total: 0,
			active: 0,
			cancelled: 0,
			byMenu: {},
			byTime: {}
		};

		// ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
		document.getElementById('staffLogin')?.addEventListener('submit', async (e) => {
			e.preventDefault();
			const formData = new FormData(e.target as HTMLFormElement);
			const password = formData.get('password') as string;
			
			await login(password);
		});

		// ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
		document.getElementById('logoutBtn')?.addEventListener('click', () => {
			logout();
		});

		// æ›´æ–°å‡¦ç†
		document.getElementById('refreshBtn')?.addEventListener('click', () => {
			loadReservations();
		});

		// ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å‡¦ç†
		['statusFilter', 'menuFilter', 'timeFilter'].forEach(id => {
			document.getElementById(id)?.addEventListener('change', () => {
				filterReservations();
			});
		});

		async function login(password: string) {
			showLoading(true);
			
			try {
				const response = await fetch(`/api/list?password=${encodeURIComponent(password)}`);
				const data = await response.json();
				
				if (response.ok) {
					currentPassword = password;
					reservationsData = data.reservations;
					statsData = data.stats;
					
					showLoginForm(false);
					showDashboard(true);
					updateStats();
					populateFilters();
					renderReservations();
				} else {
					showError(data.error || 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ');
				}
			} catch (error) {
				showError('ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
			} finally {
				showLoading(false);
			}
		}

		function logout() {
			currentPassword = '';
			reservationsData = [];
			statsData = {
				total: 0,
				active: 0,
				cancelled: 0,
				byMenu: {},
				byTime: {}
			};
			
			showDashboard(false);
			showLoginForm(true);
			showError('', false);
			
			// ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
			(document.getElementById('staffLogin') as HTMLFormElement)?.reset();
		}

		async function loadReservations() {
			if (!currentPassword) return;
			
			showLoading(true);
			
			try {
				const response = await fetch(`/api/list?password=${encodeURIComponent(currentPassword)}`);
				const data = await response.json();
				
				if (response.ok) {
					reservationsData = data.reservations;
					statsData = data.stats;
					updateStats();
					populateFilters();
					renderReservations();
				} else {
					showError(data.error || 'ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
				}
			} catch (error) {
				showError('ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
			} finally {
				showLoading(false);
			}
		}

		async function cancelReservation(reservationId: string) {
			if (!confirm('ã“ã®äºˆç´„ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿ')) return;
			
			showLoading(true);
			
			try {
				const response = await fetch('/api/list', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify({
						action: 'cancel',
						reservationId,
						password: currentPassword
					}),
				});
				
				const data = await response.json();
				
				if (response.ok) {
					await loadReservations(); // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
				} else {
					showError(data.error || 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ');
				}
			} catch (error) {
				showError('ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
			} finally {
				showLoading(false);
			}
		}

		function updateStats() {
			const statsContainer = document.getElementById('stats');
			if (!statsContainer) return;
			
			statsContainer.innerHTML = `
				<div class="stat-card">
					<h4>ğŸ“Š ç·äºˆç´„æ•°</h4>
					<div class="stat-number">${statsData?.total || 0}</div>
				</div>
				<div class="stat-card">
					<h4>âœ… æœ‰åŠ¹äºˆç´„</h4>
					<div class="stat-number active">${statsData?.active || 0}</div>
				</div>
				<div class="stat-card">
					<h4>âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«</h4>
					<div class="stat-number cancelled">${statsData?.cancelled || 0}</div>
				</div>
				<div class="stat-card">
					<h4>ğŸ½ï¸ äººæ°—ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h4>
					<div class="stat-text">${getTopMenu()}</div>
				</div>
			`;
		}

		function getTopMenu() {
			if (!statsData?.byMenu || Object.keys(statsData.byMenu).length === 0) {
				return 'ãƒ‡ãƒ¼ã‚¿ãªã—';
			}
			
			const topMenu = Object.entries(statsData.byMenu)
				.sort(([,a], [,b]) => (b as number) - (a as number))[0];
			
			const menuNames: Record<string, string> = {
				yakisoba: 'ç„¼ããã°',
				takoyaki: 'ãŸã“ç„¼ã',
				karaage: 'ã‹ã‚‰ã‚ã’',
				yakitori: 'ç„¼ãé³¥',
				drink: 'é£²ã¿ç‰©ã‚»ãƒƒãƒˆ'
			};
			
			return `${menuNames[topMenu[0]] || topMenu[0]} (${topMenu[1]}ä»¶)`;
		}

		function populateFilters() {
			const menuFilter = document.getElementById('menuFilter') as HTMLSelectElement;
			const timeFilter = document.getElementById('timeFilter') as HTMLSelectElement;
			
			if (menuFilter) {
				menuFilter.innerHTML = '<option value="all">ã™ã¹ã¦ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼</option>';
				Object.keys(statsData?.byMenu || {}).forEach(menu => {
					const menuNames: Record<string, string> = {
						yakisoba: 'ç„¼ããã°',
						takoyaki: 'ãŸã“ç„¼ã',
						karaage: 'ã‹ã‚‰ã‚ã’',
						yakitori: 'ç„¼ãé³¥',
						drink: 'é£²ã¿ç‰©ã‚»ãƒƒãƒˆ'
					};
					menuFilter.innerHTML += `<option value="${menu}">${menuNames[menu] || menu}</option>`;
				});
			}
			
			if (timeFilter) {
				timeFilter.innerHTML = '<option value="all">ã™ã¹ã¦ã®æ™‚é–“å¸¯</option>';
				Object.keys(statsData?.byTime || {}).forEach(time => {
					timeFilter.innerHTML += `<option value="${time}">${time}</option>`;
				});
			}
		}

		function filterReservations() {
			const statusFilter = (document.getElementById('statusFilter') as HTMLSelectElement).value;
			const menuFilter = (document.getElementById('menuFilter') as HTMLSelectElement).value;
			const timeFilter = (document.getElementById('timeFilter') as HTMLSelectElement).value;
			
			let filtered = reservationsData;
			
			if (statusFilter !== 'all') {
				filtered = filtered.filter(r => r.status === statusFilter);
			}
			
			if (menuFilter !== 'all') {
				filtered = filtered.filter(r => r.menu === menuFilter);
			}
			
			if (timeFilter !== 'all') {
				filtered = filtered.filter(r => r.time === timeFilter);
			}
			
			renderReservations(filtered);
		}

		function renderReservations(reservations = reservationsData) {
			const container = document.getElementById('reservationsList');
			if (!container) return;
			
			if (reservations.length === 0) {
				container.innerHTML = '<div class="no-data">äºˆç´„ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
				return;
			}
			
			const menuNames: Record<string, string> = {
				yakisoba: 'ç„¼ããã°',
				takoyaki: 'ãŸã“ç„¼ã',
				karaage: 'ã‹ã‚‰ã‚ã’',
				yakitori: 'ç„¼ãé³¥',
				drink: 'é£²ã¿ç‰©ã‚»ãƒƒãƒˆ'
			};
			
			container.innerHTML = reservations.map(reservation => `
				<div class="reservation-card ${reservation.status}">
					<div class="reservation-header">
						<div class="reservation-id">ID: ${reservation.id.substring(0, 8)}...</div>
						<div class="reservation-status status-${reservation.status}">
							${reservation.status === 'active' ? 'æœ‰åŠ¹' : 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«'}
						</div>
					</div>
					<div class="reservation-body">
						<div class="reservation-info">
							<strong>ğŸ‘¤ ${reservation.name}</strong>
							<div>ğŸ“ ${reservation.phone}</div>
							${reservation.email ? `<div>ğŸ“§ ${reservation.email}</div>` : ''}
							<div>ğŸ‘¥ ${reservation.people}å</div>
							<div>ğŸ½ï¸ ${menuNames[reservation.menu] || reservation.menu}</div>
							<div>â° ${reservation.time}</div>
							${reservation.notes ? `<div>ğŸ“ ${reservation.notes}</div>` : ''}
							<div class="reservation-date">ğŸ“… ${new Date(reservation.createdAt).toLocaleString('ja-JP')}</div>
						</div>
						${reservation.status === 'active' ? `
							<div class="reservation-actions">
								<button onclick="cancelReservation('${reservation.id}')" class="cancel-btn">
									ã‚­ãƒ£ãƒ³ã‚»ãƒ«
								</button>
							</div>
						` : ''}
					</div>
				</div>
			`).join('');
		}

		function showLoginForm(show: boolean) {
			const element = document.getElementById('loginForm');
			if (element) {
				element.classList.toggle('hidden', !show);
			}
		}

		function showDashboard(show: boolean) {
			const element = document.getElementById('dashboard');
			if (element) {
				element.classList.toggle('hidden', !show);
			}
		}

		function showLoading(show: boolean) {
			const element = document.getElementById('loading');
			if (element) {
				element.classList.toggle('hidden', !show);
			}
		}

		function showError(message: string, show: boolean = true) {
			const element = document.getElementById('error');
			if (element) {
				element.textContent = message;
				element.classList.toggle('hidden', !show);
			}
		}

		// ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å®šç¾©ï¼ˆHTMLã‹ã‚‰å‘¼ã³å‡ºã™ãŸã‚ï¼‰
		(window as any).cancelReservation = cancelReservation;
	</script>

	<style>
		.container {
			max-width: 1200px;
			margin: 0 auto;
			padding: 2rem;
		}

		header {
			text-align: center;
			margin-bottom: 2rem;
		}

		header h1 {
			color: #1f2937;
			font-size: 2.5rem;
			margin-bottom: 0.5rem;
		}

		header p {
			color: #6b7280;
			font-size: 1.1rem;
		}

		.login-form {
			max-width: 400px;
			margin: 0 auto;
			background: white;
			padding: 2rem;
			border-radius: 12px;
			box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
		}

		.login-form h2 {
			text-align: center;
			margin-bottom: 1.5rem;
			color: #1f2937;
		}

		.form-group {
			margin-bottom: 1.5rem;
		}

		label {
			display: block;
			margin-bottom: 0.5rem;
			font-weight: 600;
			color: #374151;
		}

		input, select {
			width: 100%;
			padding: 0.75rem;
			border: 2px solid #e5e7eb;
			border-radius: 8px;
			font-size: 1rem;
			transition: border-color 0.2s;
		}

		input:focus, select:focus {
			outline: none;
			border-color: #3b82f6;
		}

		.login-btn, .refresh-btn, .logout-btn {
			padding: 0.75rem 1.5rem;
			border: none;
			border-radius: 8px;
			font-weight: 600;
			cursor: pointer;
			transition: background-color 0.2s;
		}

		.login-btn {
			width: 100%;
			background: #3b82f6;
			color: white;
			font-size: 1.1rem;
		}

		.login-btn:hover {
			background: #2563eb;
		}

		.dashboard {
			background: white;
			padding: 2rem;
			border-radius: 12px;
			box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
		}

		.dashboard-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 2rem;
			padding-bottom: 1rem;
			border-bottom: 2px solid #e5e7eb;
		}

		.dashboard-header h2 {
			color: #1f2937;
			margin: 0;
		}

		.actions {
			display: flex;
			gap: 1rem;
		}

		.refresh-btn {
			background: #10b981;
			color: white;
		}

		.refresh-btn:hover {
			background: #059669;
		}

		.logout-btn {
			background: #ef4444;
			color: white;
		}

		.logout-btn:hover {
			background: #dc2626;
		}

		.stats-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
			gap: 1rem;
			margin-bottom: 2rem;
		}

		.stat-card {
			background: #f9fafb;
			padding: 1.5rem;
			border-radius: 8px;
			text-align: center;
			border: 2px solid #e5e7eb;
		}

		.stat-card h4 {
			margin: 0 0 0.5rem 0;
			color: #6b7280;
			font-size: 0.9rem;
		}

		.stat-number {
			font-size: 2rem;
			font-weight: bold;
			color: #1f2937;
		}

		.stat-number.active {
			color: #10b981;
		}

		.stat-number.cancelled {
			color: #ef4444;
		}

		.stat-text {
			font-size: 1.1rem;
			font-weight: 600;
			color: #3b82f6;
		}

		.reservations-section h3 {
			color: #1f2937;
			margin-bottom: 1rem;
		}

		.filters {
			display: flex;
			gap: 1rem;
			margin-bottom: 1rem;
			flex-wrap: wrap;
		}

		.filters select {
			min-width: 150px;
		}

		.reservations-list {
			max-height: 600px;
			overflow-y: auto;
		}

		.reservation-card {
			border: 2px solid #e5e7eb;
			border-radius: 8px;
			margin-bottom: 1rem;
			padding: 1rem;
			transition: border-color 0.2s;
		}

		.reservation-card.active {
			border-color: #10b981;
		}

		.reservation-card.cancelled {
			border-color: #ef4444;
			opacity: 0.7;
		}

		.reservation-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 1rem;
		}

		.reservation-id {
			font-family: monospace;
			color: #6b7280;
			font-size: 0.9rem;
		}

		.reservation-status {
			padding: 0.25rem 0.75rem;
			border-radius: 20px;
			font-size: 0.8rem;
			font-weight: 600;
		}

		.status-active {
			background: #d1fae5;
			color: #065f46;
		}

		.status-cancelled {
			background: #fee2e2;
			color: #991b1b;
		}

		.reservation-body {
			display: flex;
			justify-content: space-between;
			align-items: flex-start;
		}

		.reservation-info {
			flex: 1;
		}

		.reservation-info div {
			margin-bottom: 0.5rem;
			color: #374151;
		}

		.reservation-date {
			color: #6b7280;
			font-size: 0.9rem;
			margin-top: 1rem;
		}

		.reservation-actions {
			margin-left: 1rem;
		}

		.cancel-btn {
			background: #ef4444;
			color: white;
			border: none;
			padding: 0.5rem 1rem;
			border-radius: 6px;
			cursor: pointer;
			font-size: 0.9rem;
		}

		.cancel-btn:hover {
			background: #dc2626;
		}

		.loading {
			text-align: center;
			padding: 2rem;
		}

		.spinner {
			width: 40px;
			height: 40px;
			margin: 0 auto 1rem;
			border: 4px solid #e5e7eb;
			border-top: 4px solid #3b82f6;
			border-radius: 50%;
			animation: spin 1s linear infinite;
		}

		@keyframes spin {
			0% { transform: rotate(0deg); }
			100% { transform: rotate(360deg); }
		}

		.error {
			background: #fee2e2;
			color: #991b1b;
			padding: 1rem;
			border-radius: 8px;
			margin: 1rem 0;
			text-align: center;
		}

		.no-data {
			text-align: center;
			color: #6b7280;
			padding: 2rem;
		}

		.hidden {
			display: none;
		}

		body {
			background: #f3f4f6;
			min-height: 100vh;
			font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
		}

		@media (max-width: 768px) {
			.dashboard-header {
				flex-direction: column;
				gap: 1rem;
				align-items: stretch;
			}

			.actions {
				justify-content: center;
			}

			.stats-grid {
				grid-template-columns: 1fr;
			}

			.filters {
				flex-direction: column;
			}

			.reservation-body {
				flex-direction: column;
			}

			.reservation-actions {
				margin-left: 0;
				margin-top: 1rem;
			}
		}
	</style>
</Layout>
